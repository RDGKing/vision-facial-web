<!doctype html>
<html lang="es" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detección Facial | OpenCV + MediaPipe</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Estilos personalizados -->
  <link href="./assets/css/styles.css" rel="stylesheet">

  <!-- Favicon en formato SVG embebido -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%231b1f2a'/%3E%3Cpath d='M20 24h24l4 6v14a4 4 0 0 1-4 4H20a4 4 0 0 1-4-4V30z' fill='%23a3e635'/%3E%3Ccircle cx='32' cy='36' r='8' fill='%230ea5e9'/%3E%3C/svg%3E">
</head>
<body>
  <!-- Navbar superior -->
  <nav class="navbar navbar-expand-lg navbar-dark glass-nav border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2 brand" href="#">
        <span class="logo-dot"></span>
        Detección Facial
      </a>
      <!-- Botón hamburguesa para móviles -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Menú derecho -->
      <div id="navMain" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3">
          <li class="nav-item small text-secondary">OpenCV.js + MediaPipe FaceMesh</li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="container py-4">
    <div class="row g-4">
      <!-- Columna izquierda (video + controles principales) -->
      <div class="col-lg-8">
        <div id="stage" class="glass p-1 rounded-4 position-relative">
          <!-- Video de la cámara -->
          <video id="video" playsinline autoplay muted></video>
          <!-- Canvas para dibujar landmarks o resultados -->
          <canvas id="overlay" width="960" height="540"></canvas>
          <!-- Canvas oculto para procesamiento interno -->
          <canvas id="out" style="display:none"></canvas>
          <!-- Estado actual del sistema -->
          <div class="status-badge">
            <span class="badge text-bg-dark-subtle border border-secondary-subtle">Status: <span id="status">INIT…</span></span>
          </div>
        </div>

        <!-- Controles debajo del video -->
        <div class="row g-3 mt-3 align-items-center">
          <div class="col-12 col-md-6">
            <!-- Interruptor para activar modo depuración -->
            <div class="form-check form-switch glass-control debug-chip">
              <input class="form-check-input" type="checkbox" id="debugToggle">
              <label class="form-check-label" for="debugToggle">Depuración</label>
            </div>
          </div>
          <div class="col-12 col-md-6 text-md-end">
            <!-- Botones de control -->
            <button id="recalBtn" class="btn btn-outline-info btn-sm">Recalibrar (2s)</button>
            <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reiniciar contadores</button>
          </div>
        </div>
      </div>

      <!-- Columna derecha (estadísticas, sliders y métricas en vivo) -->
      <div class="col-lg-4">
        <!-- Contadores de expresiones -->
        <div class="card glass border-0 shadow-none">
          <div class="card-body">
            <h5 class="card-title mb-3">Contadores</h5>
            <!-- Parpadeos -->
            <div class="d-flex justify-content-between align-items-center mb-3 stat-row">
              <div class="d-flex align-items-center gap-2">
                <span class="stat-dot dot-eye"></span><span>Parpadeos</span>
              </div>
              <span id="cBlinks" class="metric h3 mb-0">0</span>
            </div>
            <!-- Boca abierta -->
            <div class="d-flex justify-content-between align-items-center mb-3 stat-row">
              <div class="d-flex align-items-center gap-2">
                <span class="stat-dot dot-mouth"></span><span>Boca abierta</span>
              </div>
              <span id="cMouth" class="metric h3 mb-0">0</span>
            </div>
            <!-- Cejas alzadas -->
            <div class="d-flex justify-content-between align-items-center stat-row">
              <div class="d-flex align-items-center gap-2">
                <span class="stat-dot dot-brow"></span><span>Cejas alzadas</span>
              </div>
              <span id="cBrow" class="metric h3 mb-0">0</span>
            </div>
          </div>
        </div>

        <!-- Sliders para ajustar sensibilidad -->
        <div class="card glass mt-3 border-0 shadow-none">
          <div class="card-body">
            <h6 class="card-title mb-3">Sensibilidad (Δ respecto a la línea base)</h6>
            <!-- Slider de parpadeo -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label small-label">Blink (ΔEAR)</label>
                <span class="small text-secondary"><span id="blinkVal">0.070</span></span>
              </div>
              <input type="range" min="0.02" max="0.14" step="0.005" value="0.07" id="blinkRange" class="form-range range-modern">
            </div>
            <!-- Slider de boca -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label small-label">Boca (ΔMAR)</label>
                <span class="small text-secondary"><span id="mouthVal">0.100</span></span>
              </div>
              <input type="range" min="0.03" max="0.20" step="0.005" value="0.10" id="mouthRange" class="form-range range-modern">
            </div>
            <!-- Slider de cejas -->
            <div>
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label small-label">Cejas (ΔBROW)</label>
                <span class="small text-secondary"><span id="browVal">0.100</span></span>
              </div>
              <input type="range" min="0.03" max="0.20" step="0.005" value="0.10" id="browRange" class="form-range range-modern">
            </div>
          </div>
        </div>

        <!-- Métricas en tiempo real -->
        <div class="card glass mt-3 border-0 shadow-none">
          <div class="card-body">
            <h6 class="card-title">Métricas en vivo</h6>
            <div class="small-label">EAR / base</div>
            <div class="metric mono" id="mEAR">—</div>
            <div class="small-label mt-2">MAR / base</div>
            <div class="metric mono" id="mMAR">—</div>
            <div class="small-label mt-2">BROW / base</div>
            <div class="metric mono" id="mBROW">—</div>
            <!-- Mensaje de calibración -->
            <div class="mt-2 small text-secondary" id="calibMsg">Calibrando línea base…</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer glass-nav border-top">
    <div class="container py-3 d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
      <div class="small text-secondary">
        Desarrollado por <strong>Angel Rodrigo Barrios Yáñez</strong>
      </div>
      <div class="d-flex align-items-center gap-2 small">
        <span class="text-secondary">•</span>
        <a class="link-secondary" href="https://github.com/RDGKing" target="_blank" rel="noopener">GitHub @RDGKing</a>
      </div>
    </div>
  </footer>

  <!-- Librerías de MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <!-- Scripts personalizados -->
  <script src="./assets/js/metrics.js"></script>
  <script src="./assets/js/app.js"></script>

  <!-- OpenCV.js (async) -->
  <script async src="https://docs.opencv.org/4.8.0/opencv.js"
          onload="cv['onRuntimeInitialized']=()=>{ window.__cvReady = true; }"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
